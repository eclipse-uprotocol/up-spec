/*
 * SPDX-FileCopyrightText: 2023 Contributors to the Eclipse Foundation
 *
 * See the NOTICE file(s) distributed with this work for additional
 * information regarding copyright ownership.
 * 
 * This program and the accompanying materials are made available under
 * the terms of the Apache License Version 2.0 which is available at
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * SPDX-FileType: SOURCE
 * SPDX-License-Identifier: Apache-2.0
 */

syntax = "proto3";

package uprotocol.core.usubscription.v3;

import "google/protobuf/any.proto";
import "google/protobuf/timestamp.proto";
import "uprotocol/v1/uri.proto";
import "uprotocol/uoptions.proto";

option java_package = "org.eclipse.uprotocol.core.usubscription.v3";
option java_outer_classname = "USubscriptionProto";
option java_multiple_files = true;

// Enable generation of generic service attributes in C++
option cc_generic_services = true;

// Subscription service interface definition
service uSubscription {
  option (uprotocol.service_name) = "core.usubscription";
  option (uprotocol.service_version_major) = 3;
  option (uprotocol.service_version_minor) = 0;
  option (uprotocol.service_id) = 0;

  // uSubscription change Notification topic used for Update messages
  option (uprotocol.notification_topic) = {
    id: 0x8000,
    name: "SubscriptionChange",
    message: "Update"
  };

  // Register the calling client as subscriber to a topic, passing a SubscriptionRequest
  // message containing the desired topic and optional SubscriptionAttributes. 
  // * Returns a SubscriptionResponse message containing the status of the request,
  //   along with any event delivery configuration required to consume the event. 
  // * Calling this endpoint also registers the subscribing client to receive subscription
  //   change notifications when the subscription state changes.
  rpc Subscribe(SubscriptionRequest) returns (SubscriptionResponse) {
    option (uprotocol.method_id) = 1;
  }

  // Unregister the calling susbcriber client from a topic.
  // * Returns a UnsubscripeResponse message containing the updated status of the subscription.
  // * Calling this endpoint also unregisters the client from receiving subscription change 
  //   notifications for this subscription.
  rpc Unsubscribe(UnsubscribeRequest) returns (UnsubscribeResponse) {
    option (uprotocol.method_id) = 2;
  }

  // Fetch a list of subscribers that are currently subscribed to a given topic.
  rpc FetchSubscribers(FetchSubscribersRequest) returns (FetchSubscribersResponse) {
    option (uprotocol.method_id) = 8;
  }

  // Fetch a list of subscriptions for a given subscriber or topic.
  rpc FetchSubscriptions(FetchSubscriptionsRequest) returns (FetchSubscriptionsResponse) {
    option (uprotocol.method_id) = 3;
  }

  // Register client to receive subscription change notifications for a given topic.
  rpc RegisterForNotifications(NotificationsRequest) returns (NotificationsResponse) {
    option (uprotocol.method_id) = 6;
  }

  // Unregister client from receiving subscription change events for a given topic.
  rpc UnregisterForNotifications(NotificationsRequest) returns (NotificationsResponse) {
    option (uprotocol.method_id) = 7;
  }

  // Reset all subscriber-topic registrations of a uSubscription Service.
  // A (remote) uSubscription service instance might need to use this API if its 
  // database gets lost or corrupted (ex. during a factory reset).
  // * This is a private API, to be used only between uSubscription service entities.
  rpc Reset(ResetRequest) returns (ResetResponse) {
    option (uprotocol.method_id) = 9;
  }
}

// Subscription configuration information
message SubscribeAttributes {
  // Define when the subscription should expire (timestamp should be set in the future).
  // * If this field is missing, the subscription is assumed to remain valid indefinitely.
  // * If the timestamp is set in the past when evaluated by uSubscription service, no subscription 
  //   should be registered and an appropriate result message returned to the caller.
  google.protobuf.Timestamp expire = 1;

  // Any additional producer specific information that the consumer needs to send
  // as part of a subscription request
  repeated google.protobuf.Any details = 2;

  // Desired sampling period (in milliseconds) the subscriber wishes to receive
  // events in, applicable only for remote topics. Device dispatchers (i.e. streamers) use
  // this attribute to reduce the publication rate of messages sent between devices.
  // This attribute is might e.g. be used by mobile/cloud clients subscribing to in-vehicle 
  // topics that in their original scope are published at a high rate.
  // * If the desired sampling period is lower than the original publisher's publication period,
  //   the attribute is ignored.
  // * If this attribute is missing, the sampling period is chosen by the publisher.
  optional uint32 sample_period_ms = 3;
}

// Subscriber identification information
message SubscriberInfo {
  // URI of the subscribing uEntity. Example represented in long form: `//vin.vehicles/A8000/2/0`
  // * The resource_id field of SubscriberInfo URIs MUST be 0.
  // * Wildcard URIs are not permitted.
  uprotocol.v1.UUri uri = 1;

  reserved 2;
}

// Subscription status
message SubscriptionStatus {
  enum State {
    UNSUBSCRIBED = 0; // Default state to indicate not subscribed
    SUBSCRIBE_PENDING = 1; // Subscription is pending confirmation from remote uSubscription service instance
    SUBSCRIBED = 2; // Subscription has been successful
    UNSUBSCRIBE_PENDING = 3; // Unsubscribe is pending confirmation from remote uSubscription service instance
  }
  // Subscription state
  State state = 1;

  reserved 2;

  // The Subscription status message
  string message = 3;
}

// How events will be delivered to the subscriber. Usage of this structure is device-dependent.
message EventDeliveryConfig {
  // Identifier for the event delivery endpoint, ex. topic name for events to be published to
  // example for Azure uCloud: "SUBSCRIPTION_TOPIC"
  string id = 1;

  // What type of endpoint shall be used to deliver the events for said subscription
  // example for Azure uCloud: "Microsoft.EventHub/Namespaces/EventHubs"
  string type = 2;

  // Any additional configuration attributes
  map <string, google.protobuf.Any>  attributes = 3;
}

// Passed to Subscribe() endpoint, this message contains the topic to subscribe to.
message SubscriptionRequest {
  // uProtocol URI of the topic to subscribe to
  uprotocol.v1.UUri topic = 1;

  reserved 2;

  // Additional subscription attributes
  SubscribeAttributes attributes = 3;
}

// Response message for the Subscribe() endpoint.
message SubscriptionResponse {
  // Current status of the subscription
  SubscriptionStatus status = 1;

  // Any platform-specific event delivery configuration on how the subscriber
  // should consume published events
  EventDeliveryConfig config = 2;

  // Subscribed topic, as passed to SubscriptionRequest
  uprotocol.v1.UUri topic = 3;
}

// Passed to the Unsubscribe() endpoint, this message contains the topic to unsubscribe from.
message UnsubscribeRequest {
  // Topic to unsubscribe from
  uprotocol.v1.UUri topic = 1;

  reserved 2;
}

// The (empty) response message indicating the execution of the Unsubscribe() operation.
message UnsubscribeResponse {}

// Passed to FetchSubscribers() to obtain a list of subscribers to a given topic.
message FetchSubscribersRequest {
  reserved 2;

  // Topic to list the subscribers for
  uprotocol.v1.UUri topic = 1;
}


// Returned from FetchSubscribers(), this message contains a list of SubscriberInfo elements.
message FetchSubscribersResponse {
  // List of subscribers
  repeated SubscriberInfo subscribers = 1;

  reserved 2, 3;
}


// Subscription information message that is returned by FetchSubscriptions() endpoint.
message Subscription {
  // Subscription topic
  uprotocol.v1.UUri topic = 1;

  // Information about the subscriber
  SubscriberInfo subscriber = 2;

  // Current status of the subscription
  SubscriptionStatus status = 3;

  // Subscriber attributes
  SubscribeAttributes attributes = 4;

  // Any platform-specific event delivery configuration on how the subscriber
  // should consume published events
  EventDeliveryConfig config = 5;
}

// Passed to FetchSubscriptions() to obtain a list of Subscription(s) to a particular topic 
// or from a given subscriber.
message FetchSubscriptionsRequest {
  oneof request {
    // Topic to return subscribed clients for
    uprotocol.v1.UUri topic = 1;

    // Subscriber to return topic subscriptions of
    SubscriberInfo subscriber = 2;
  }

  reserved 3;
}

// Results from FetchSubscriptions() endpoint, returning a list of Subscription elements.
message FetchSubscriptionsResponse {
  // List of subscriptions of a subscriber
  repeated Subscription subscriptions = 1;

  reserved 2;
}

// Passed to the RegisterForSubscriptionChanges() and UnregisterForSubscriptionChanges()
// endpoints, this message includes the topic to register for subscription change notifications.
message NotificationsRequest {
  // Topic to register/unregister subscription change notifications for
  uprotocol.v1.UUri topic = 1;

  reserved 2;
}

// The (empty) response message indicating successful execution of the
// RegisterForSubscriptionChanges and UnregisterForSubscriptionChanges operations.
message NotificationsResponse {}

// Subscription Update Message.
// This Update message is sent by uSusbcription service on the topic:
// `/core.usubscription/3/subscriptions#Update` whenever there is a change to
// a subscription.
// Topic subscribers automatically receive this notification directly, as well as any uEntities 
// that  explicitly called RegisterForNotifications() for the topics inquestion.
message Update {
  // Topic the subscription state of which has changed
  uprotocol.v1.UUri topic = 1;

  // Information about the subscriber who requested the subscription change
  SubscriberInfo subscriber = 2;

  // Current status of the subscription
  SubscriptionStatus status = 3;

  // Subscribers subscription attributes
  SubscribeAttributes attributes = 4;

  // Service meta-data option definitions - Resources
  enum Resources { subscriptions = 0; }
}

// Passive Subscription Mode.
// Passive subscriptions, in lieu of active ones, do not modify (the state) nor
// notify the publisher of the subscribers subscription. Passive subscriptions
// are a means to support observability frameworks to passively listen for
// events.
// *NOTE*: This attribute is an internal platform setting (for now) and not
// exposed as part of SubscribeAttributes.
message PassiveMode {
  bool enable = 1; // Enable passive subscription mode
}


// Reset subscriptions request
// This message can provide the reason for the reset request.
message ResetRequest {
  // Reason for the reset
  optional Reason reason = 1;

  // DEPRECATED
  // Reset all subscriptions that are before this time, if omitted, the
  // current time is assumed
  //optional google.protobuf.Timestamp before = 2;
  reserved 2;

  // The reason for triggering a reset, this is an optional attribute used
  // to provide insight as to why a reset occurred.
  message Reason {
    Code code = 1; // Reason code
    optional string message = 2; // Reason message

    // Reason code
    enum Code {
      UNSPECIFIED = 0; // Default non-specified reason for issuing a reset
      FACTORY_RESET = 1; // Factory reset
      CORRUPTED_DATA = 2; // Corrupted data
    }
  }
}

// The (empty) response message indicating the successful execution of the Reset operation.
message ResetResponse {}
